=================================================================
KONSEP ARSITEKTUR
=================================================================



=================================================================
IMPLEMENTASI
=================================================================
siap—kita fokus “membongkar” controller pendaftaran yang gemuk jadi potongan kecil yang rapi. Karena kamu minta **belum menulis kode**, di bawah ini adalah **daftar file** + **peran masing-masing** yang biasanya diperlukan untuk kasus pendaftaran peserta (dengan entitas: peserta, user/operator, instansi, bidang, pelatihan, lampiran, dan alur status).

---

# 0) Gambaran permasalahan di controller gemuk

Biasanya berisi campuran:

* Validasi request (panjang)
* Otorisasi (role/ownership)
* Query & filter list (search, sort, paginate)
* Transaksi bisnis (generate nomor registrasi, cek unik, simpan lampiran)
* Perubahan status (submit/verify/approve/reject)
* Notifikasi/email, export, dsb.

Semuanya kita **pecah**: validasi → FormRequest, logika bisnis → Actions/Services, otorisasi → Policy, query → Repository/QueryObject, lampiran → Service khusus storage, output API → Resource, efek samping → Event/Listener/Job, aturan khusus → Rule, hal otomatis → Observer. Controller tinggal jadi *orchestrator* tipis.

---

# 1) HTTP Requests (validasi & otorisasi per-endpoint)

Taruh semua aturan validasi di sini, bukan di controller.

* `app/Http/Requests/Pendaftaran/StoreRequest.php`
* `app/Http/Requests/Pendaftaran/UpdateRequest.php`
* `app/Http/Requests/Pendaftaran/ChangeStatusRequest.php` (opsional)
* `app/Http/Requests/Pendaftaran/UploadLampiranRequest.php`

**Fokus:** aturan field, exists/unique, korelasi antar field (mis. `bidang_id` harus milik `instansi_id`), otorisasi endpoint (boleh create/edit?).

---

# 2) Policies (izin per aksi pada model)

Agar controller tidak penuh if/else per role/status.

* `app/Policies/PendaftaranPolicy.php`

**Method umum:** `viewAny, view, create, update, delete, restore, forceDelete` + kustom mis. `approve, reject, verify, uploadLampiran`.

---

# 3) Domain Actions / Services (logika bisnis inti)

Satu use-case → satu kelas. Di sinilah **transaksi DB** berlangsung.

* `app/Actions/Pendaftaran/CreatePendaftaran.php`
  (cek unik peserta×pelatihan, generate nomor, simpan & dispatch event)
* `app/Actions/Pendaftaran/UpdatePendaftaran.php`
* `app/Actions/Pendaftaran/ChangeStatus.php`
  (subset: `ApprovePendaftaran`, `RejectPendaftaran`, `VerifyPendaftaran`)
* `app/Actions/Pendaftaran/AddLampiran.php`
* `app/Actions/Pendaftaran/RemoveLampiran.php`
* `app/Actions/Pendaftaran/GenerateNomorRegistrasi.php` (bisa sebagai service mikro)

> Catatan: kalau di controller ada 3–5 alur berbeda (create/update/status/lampiran), pecah jadi **3–5 Action** seperti di atas.

---

# 4) Rules (aturan validasi custom & lintas field)

Supaya tidak menjejali FormRequest dengan closure panjang.

* `app/Rules/UniquePendaftaranPerPesertaPelatihan.php`
* `app/Rules/BidangBelongsToInstansi.php`
* `app/Rules/ValidLampiranType.php` (opsional: cek jenis berkas terhadap pelatihan/bidang)

---

# 5) Repositories / Query Objects (query & filter rapi)

Kumpulkan logika pencarian/sort/filter/paginate.

* `app/Repositories/PendaftaranRepository.php`
  (mis. `paginateWithFilters($filters)`, `findByNomor($nomor)`)
* (opsional) `app/QueryBuilders/PendaftaranQuery.php` bila ingin pola QueryObject lebih ketat.

**Tujuan:** controller tidak menulis chain query panjang, cukup panggil metode repository.

---

# 6) HTTP Resources (format respons API)

Kalau endpoint kamu JSON, bentuknya jangan di controller.

* `app/Http/Resources/PendaftaranResource.php`
* `app/Http/Resources/LampiranResource.php`

**Manfaat:** konsisten, mudah versi, dan controller tetap tipis.

---

# 7) Services (utilitas domain & infrastruktur)

Pisahkan hal yang berpotensi dipakai lintas aksi.

* `app/Services/Numbering/NomorRegistrasiFormatter.php`
  (format kode, padding, pola per tahun/bidang)
* `app/Services/Storage/LampiranStorage.php`
  (path, direktori, rename, keamanan akses)
* (opsional) `app/Services/Export/PendaftaranExporter.php` (CSV/XLSX/PDF)

---

# 8) Events, Listeners, Jobs (efek samping asinkron)

Agar controller/Action tak menangani email, logging berat, dsb.

* `app/Events/PendaftaranSubmitted.php`
* `app/Events/PendaftaranApproved.php`
* `app/Events/PendaftaranRejected.php`
* `app/Listeners/NotifyPesertaOnApproval.php`
* `app/Jobs/SendPendaftaranEmail.php`
* `app/Jobs/GenerateKartuPendaftaranPdf.php`

**Prinsip:** Action hanya `dispatch()`; proses berat jalan di Job.

---

# 9) Observers (otomatisasi dekat model)

Hal “otomatis” saat create/update tanpa mencemari controller.

* `app/Observers/PendaftaranObserver.php`
  (mis. auto-generate nomor kalau kosong, normalisasi data)
* `app/Observers/LampiranObserver.php` (opsional—hapus fisik file saat record dihapus)

---

# 10) Controllers (jadi super tipis)

Hanya orkestrasi: terima Request → authorize → panggil Action → balas Resource/View.

* Tetap `app/Http/Controllers/PendaftaranController.php` (lebih kecil)
* (opsional) pisah **Web** vs **API**:

  * `PendaftaranWebController` (Blade)
  * `PendaftaranApiController` (JSON + Resource)

---

# 11) Views / Blade Components (untuk portal publik)

Jika ada UI publik (non-admin):

* `resources/views/pendaftaran/create.blade.php`
* `resources/views/pendaftaran/show.blade.php`
* `resources/views/components/pendaftaran/form.blade.php`
* `resources/views/components/pendaftaran/lampiran-uploader.blade.php`

**Tujuan:** markup tidak menumpuk di controller, dan form bisa reusable.

---

# 12) Filament (untuk back-office/admin)

Jika kamu juga pakai Filament, UI admin pindah ke sini (controller makin bebas).

* `app/Filament/Resources/PendaftaranResource.php`
* `app/Filament/Resources/PendaftaranResource/Pages/{List,Create,Edit,View}.php`
* `app/Filament/Resources/PendaftaranResource/RelationManagers/LampiranRelationManager.php`
* `app/Filament/Widgets/PendaftaranStats.php`

**Khusus penting:** di `Create/Edit` Page, gunakan **Action** (`CreatePendaftaran`, `ChangeStatus`, dll.) agar domain logic tetap satu sumber.

---

# 13) Routes (jelas & terpisah)

* `routes/web.php` (portal)
* `routes/api.php` (API JSON)
* (opsional) `routes/filament.php` (kadang otomatis oleh Filament)
* Gunakan **Route Model Binding** untuk meringkas controller.

---

# 14) Testing (supaya refactor aman)

* `tests/Feature/Pendaftaran/CreateTest.php`
* `tests/Feature/Pendaftaran/StatusFlowTest.php`
* `tests/Unit/Rules/UniquePendaftaranPerPesertaPelatihanTest.php`
* `tests/Feature/Filament/PendaftaranResourceTest.php` (bila pakai Filament)

---

## Pemetaan “fat controller concern → file tujuan”

* **Validasi panjang** → `StoreRequest/UpdateRequest/ChangeStatusRequest` + `Rules/*`
* **Cek izin** → `PendaftaranPolicy`
* **Generate nomor registrasi** → `Actions/GenerateNomorRegistrasi` (atau Service Numbering) + optional `Observer`
* **Cek unik (peserta×pelatihan)** → `Rules/UniquePendaftaranPerPesertaPelatihan`
* **Relasi `bidang` milik `instansi`** → `Rules/BidangBelongsToInstansi`
* **Simpan/hapus lampiran** → `Actions/AddLampiran/RemoveLampiran` + `Services/Storage/LampiranStorage`
* **Filter/search daftar** → `PendaftaranRepository`
* **Perubahan status (submit/verify/approve/reject)** → `Actions/ChangeStatus` (+ Policy)
* **Notifikasi/email/export** → `Events/Listeners/Jobs` (+ optional `Services/Export`)
* **Respons JSON** → `Http/Resources/*`
* **Hal otomatis saat create/update** → `Observers/*`

---

### Hasil akhirnya

* **Controller** tinggal ±5–20 baris per method (super bersih).
* **Logika bisnis** terkumpul rapi & bisa dipakai ulang (portal, API, admin).
* **Validasi & izin** konsisten (tak tersebar).
* **Query** mudah dirawat (satu pintu).
* **Efek samping** aman via queue.

Kalau kamu mau, kirim ringkasan isi method apa saja yang ada di controller kamu (mis. `index`, `create`, `store`, `show`, `update`, `approve`, `reject`, `uploadLampiran`, `export`, dsb.). Aku akan mapping **satu-per-satu** ke daftar file di atas (tanpa menulis kode), jadi kamu dapat *blueprint* refactor yang persis mengikuti controller milikmu.
