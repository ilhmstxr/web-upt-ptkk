=================================================================
KONSEP ARSITEKTUR
=================================================================

=================================================================
IMPLEMENTASI
=================================================================
siap—kita fokus “membongkar” controller pendaftaran yang gemuk jadi potongan kecil yang rapi. Karena kamu minta **belum menulis kode**, di bawah ini adalah **daftar file** + **peran masing-masing** yang biasanya diperlukan untuk kasus pendaftaran peserta (dengan entitas: peserta, user/operator, instansi, kompetensi, pelatihan, lampiran, dan alur status).

---

# 0) Gambaran permasalahan di controller gemuk

Biasanya berisi campuran:

-   Validasi request (panjang)
-   Otorisasi (role/ownership)
-   Query & filter list (search, sort, paginate)
-   Transaksi bisnis (generate nomor registrasi, cek unik, simpan lampiran)
-   Perubahan status (submit/verify/approve/reject)
-   Notifikasi/email, export, dsb.

Semuanya kita **pecah**: validasi → FormRequest, logika bisnis → Actions/Services, otorisasi → Policy, query → Repository/QueryObject, lampiran → Service khusus storage, output API → Resource, efek samping → Event/Listener/Job, aturan khusus → Rule, hal otomatis → Observer. Controller tinggal jadi _orchestrator_ tipis.

---

# 1) HTTP Requests (validasi & otorisasi per-endpoint)

Taruh semua aturan validasi di sini, bukan di controller.

-   `app/Http/Requests/Pendaftaran/StoreRequest.php`
-   `app/Http/Requests/Pendaftaran/UpdateRequest.php`
-   `app/Http/Requests/Pendaftaran/ChangeStatusRequest.php` (opsional)
-   `app/Http/Requests/Pendaftaran/UploadLampiranRequest.php`

**Fokus:** aturan field, exists/unique, korelasi antar field (mis. `kompetensi_id` harus milik `instansi_id`), otorisasi endpoint (boleh create/edit?).

---

# 2) Policies (izin per aksi pada model)

Agar controller tidak penuh if/else per role/status.

-   `app/Policies/PendaftaranPolicy.php`

**Method umum:** `viewAny, view, create, update, delete, restore, forceDelete` + kustom mis. `approve, reject, verify, uploadLampiran`.

---

# 3) Domain Actions / Services (logika bisnis inti)

Satu use-case → satu kelas. Di sinilah **transaksi DB** berlangsung.

-   `app/Actions/Pendaftaran/CreatePendaftaran.php`
    (cek unik peserta×pelatihan, generate nomor, simpan & dispatch event)
-   `app/Actions/Pendaftaran/UpdatePendaftaran.php`
-   `app/Actions/Pendaftaran/ChangeStatus.php`
    (subset: `ApprovePendaftaran`, `RejectPendaftaran`, `VerifyPendaftaran`)
-   `app/Actions/Pendaftaran/AddLampiran.php`
-   `app/Actions/Pendaftaran/RemoveLampiran.php`
-   `app/Actions/Pendaftaran/GenerateNomorRegistrasi.php` (bisa sebagai service mikro)

> Catatan: kalau di controller ada 3–5 alur berbeda (create/update/status/lampiran), pecah jadi **3–5 Action** seperti di atas.

---

# 4) Rules (aturan validasi custom & lintas field)

Supaya tidak menjejali FormRequest dengan closure panjang.

-   `app/Rules/UniquePendaftaranPerPesertaPelatihan.php`
-   `app/Rules/KompetensiBelongsToInstansi.php`
-   `app/Rules/ValidLampiranType.php` (opsional: cek jenis berkas terhadap pelatihan/kompetensi)

---

# 5) Repositories / Query Objects (query & filter rapi)

Kumpulkan logika pencarian/sort/filter/paginate.

-   `app/Repositories/PendaftaranRepository.php`
    (mis. `paginateWithFilters($filters)`, `findByNomor($nomor)`)
-   (opsional) `app/QueryBuilders/PendaftaranQuery.php` bila ingin pola QueryObject lebih ketat.

**Tujuan:** controller tidak menulis chain query panjang, cukup panggil metode repository.

---

# 6) HTTP Resources (format respons API)

Kalau endpoint kamu JSON, bentuknya jangan di controller.

-   `app/Http/Resources/PendaftaranResource.php`
-   `app/Http/Resources/LampiranResource.php`

**Manfaat:** konsisten, mudah versi, dan controller tetap tipis.

---

# 7) Services (utilitas domain & infrastruktur)

Pisahkan hal yang berpotensi dipakai lintas aksi.

-   `app/Services/Numbering/NomorRegistrasiFormatter.php`
    (format kode, padding, pola per tahun/kompetensi)
-   `app/Services/Storage/LampiranStorage.php`
    (path, direktori, rename, keamanan akses)
-   (opsional) `app/Services/Export/PendaftaranExporter.php` (CSV/XLSX/PDF)

---

# 8) Events, Listeners, Jobs (efek samping asinkron)

Agar controller/Action tak menangani email, logging berat, dsb.

-   `app/Events/PendaftaranSubmitted.php`
-   `app/Events/PendaftaranApproved.php`
-   `app/Events/PendaftaranRejected.php`
-   `app/Listeners/NotifyPesertaOnApproval.php`
-   `app/Jobs/SendPendaftaranEmail.php`
-   `app/Jobs/GenerateKartuPendaftaranPdf.php`

**Prinsip:** Action hanya `dispatch()`; proses berat jalan di Job.

---

# 9) Observers (otomatisasi dekat model)

Hal “otomatis” saat create/update tanpa mencemari controller.

-   `app/Observers/PendaftaranObserver.php`
    (mis. auto-generate nomor kalau kosong, normalisasi data)
-   `app/Observers/LampiranObserver.php` (opsional—hapus fisik file saat record dihapus)

---

# 10) Controllers (jadi super tipis)

Hanya orkestrasi: terima Request → authorize → panggil Action → balas Resource/View.

-   Tetap `app/Http/Controllers/PendaftaranController.php` (lebih kecil)
-   (opsional) pisah **Web** vs **API**:

    -   `PendaftaranWebController` (Blade)
    -   `PendaftaranApiController` (JSON + Resource)

---

# 11) Views / Blade Components (untuk portal publik)

Jika ada UI publik (non-admin):

-   `resources/views/pendaftaran/create.blade.php`
-   `resources/views/pendaftaran/show.blade.php`
-   `resources/views/components/pendaftaran/form.blade.php`
-   `resources/views/components/pendaftaran/lampiran-uploader.blade.php`

**Tujuan:** markup tidak menumpuk di controller, dan form bisa reusable.

---

# 12) Filament (untuk back-office/admin)

Jika kamu juga pakai Filament, UI admin pindah ke sini (controller makin bebas).

-   `app/Filament/Resources/PendaftaranResource.php`
-   `app/Filament/Resources/PendaftaranResource/Pages/{List,Create,Edit,View}.php`
-   `app/Filament/Resources/PendaftaranResource/RelationManagers/LampiranRelationManager.php`
-   `app/Filament/Widgets/PendaftaranStats.php`

**Khusus penting:** di `Create/Edit` Page, gunakan **Action** (`CreatePendaftaran`, `ChangeStatus`, dll.) agar domain logic tetap satu sumber.

---

# 13) Routes (jelas & terpisah)

-   `routes/web.php` (portal)
-   `routes/api.php` (API JSON)
-   (opsional) `routes/filament.php` (kadang otomatis oleh Filament)
-   Gunakan **Route Model Binding** untuk meringkas controller.

---

# 14) Testing (supaya refactor aman)

-   `tests/Feature/Pendaftaran/CreateTest.php`
-   `tests/Feature/Pendaftaran/StatusFlowTest.php`
-   `tests/Unit/Rules/UniquePendaftaranPerPesertaPelatihanTest.php`
-   `tests/Feature/Filament/PendaftaranResourceTest.php` (bila pakai Filament)

---

## Pemetaan “fat controller concern → file tujuan”

-   **Validasi panjang** → `StoreRequest/UpdateRequest/ChangeStatusRequest` + `Rules/*`
-   **Cek izin** → `PendaftaranPolicy`
-   **Generate nomor registrasi** → `Actions/GenerateNomorRegistrasi` (atau Service Numbering) + optional `Observer`
-   **Cek unik (peserta×pelatihan)** → `Rules/UniquePendaftaranPerPesertaPelatihan`
-   **Relasi `kompetensi` milik `instansi`** → `Rules/KompetensiBelongsToInstansi`
-   **Simpan/hapus lampiran** → `Actions/AddLampiran/RemoveLampiran` + `Services/Storage/LampiranStorage`
-   **Filter/search daftar** → `PendaftaranRepository`
-   **Perubahan status (submit/verify/approve/reject)** → `Actions/ChangeStatus` (+ Policy)
-   **Notifikasi/email/export** → `Events/Listeners/Jobs` (+ optional `Services/Export`)
-   **Respons JSON** → `Http/Resources/*`
-   **Hal otomatis saat create/update** → `Observers/*`

---

### Hasil akhirnya

-   **Controller** tinggal ±5–20 baris per method (super bersih).
-   **Logika bisnis** terkumpul rapi & bisa dipakai ulang (portal, API, admin).
-   **Validasi & izin** konsisten (tak tersebar).
-   **Query** mudah dirawat (satu pintu).
-   **Efek samping** aman via queue.

Kalau kamu mau, kirim ringkasan isi method apa saja yang ada di controller kamu (mis. `index`, `create`, `store`, `show`, `update`, `approve`, `reject`, `uploadLampiran`, `export`, dsb.). Aku akan mapping **satu-per-satu** ke daftar file di atas (tanpa menulis kode), jadi kamu dapat _blueprint_ refactor yang persis mengikuti controller milikmu.

82 ~ 97

1: 81 - 115
2: 177 - 201

export pdf untuk diagram monev

export pdf & excel untuk kebutuhan bu nur
jadwal kegiatan pelatihan total 10
jenis:

-   reguler: MJC, keterampilan (generasi emas,)
-   mtu
-   aksel: sertifikasi uji kompetensi

aksel guru: 2
mtu: 2
teknik: 2
aksel siswa: 2
mjc: 2

guru & siswa

105
191

104
105

190
191
SELECT \* FROM jawaban_user WHERE pertanyaan_id = 105;

-- JALANKAN QUERY INI UNTUK MEMPERBAIKI DATA JAWABAN_USER
UPDATE
jawaban_user
SET
opsi_jawaban_id = CASE
-- ## Mapping untuk Pertanyaan 105 (Q24) ##
-- Sesuaikan ID Lama => ID Baru berdasarkan peta Anda
WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 353 THEN 708 -- Contoh untuk 'Sangat Perlu'
WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 354 THEN 707 -- Contoh untuk 'Perlu'
WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 355 THEN 706 -- Contoh untuk 'Kurang Perlu'
WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 356 THEN 705 -- Contoh untuk 'Tidak Perlu'

    -- Jaga nilai asli jika tidak cocok
    ELSE opsi_jawaban_id

END
WHERE
-- Filter hanya untuk pertanyaan yang relevan
pertanyaan_id = 105 AND opsi_jawaban_id IN (353, 354, 355, 356);

-- JALANKAN QUERY INI UNTUK MEMPERBAIKI DATA JAWABAN_USER
UPDATE
jawaban_user
SET
opsi_jawaban_id = CASE
-- ## Mapping untuk Pertanyaan 105 (Q24) ##
-- Sesuaikan ID Lama => ID Baru berdasarkan peta Anda
WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 685 THEN 712 -- Contoh untuk 'Sangat Perlu'
WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 686 THEN 711 -- Contoh untuk 'Perlu'
WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 687 THEN 710 -- Contoh untuk 'Kurang Perlu'
WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 688 THEN 709 -- Contoh untuk 'Tidak Perlu'

    -- Jaga nilai asli jika tidak cocok
    ELSE opsi_jawaban_id

END
WHERE
-- Filter hanya untuk pertanyaan yang relevan
pertanyaan_id = 191 AND opsi_jawaban_id IN (685, 686, 687, 688);

<!-- rubah db -->

ALTER TABLE percobaan
ADD COLUMN tipe ENUM('pre-test', 'post-test', 'survey') NULL AFTER tes_id;

UPDATE percobaan
SET tipe = 'survey'
WHERE (skor IS NULL OR skor = 0) AND tes_id IN (5, 9);

UPDATE percobaan
SET tipe = 'post-test'
WHERE skor IS NOT NULL AND skor > 0;

nambahin peserta_id otomatis

perubahan untuk asrama

ASRAMA
id
name
gender

KAMAR
id
asrama
nomor_kamar
lantai
status
total_beds
available_beds

penambahan kolom
tabel percobaan

-   pelatihan_id

tabel peserta

-   pretest
-   posttest
-   praktek
-   rata rata
-   nilai survei
-   status

mindah nilai ke pendafaran pelatihan
UPDATE pendaftaran_pelatihan AS pp
LEFT JOIN (
-- Subquery untuk mengambil skor pre-test terbaru
SELECT
p.peserta_id,
p.pelatihan_id,
p.skor AS nilai_pre_test
FROM percobaan AS p
INNER JOIN (
SELECT peserta_id, pelatihan_id, MAX(id) AS max_id
FROM percobaan
WHERE tipe = 'pre-test' AND peserta_id IS NOT NULL AND pelatihan_id IS NOT NULL
GROUP BY peserta_id, pelatihan_id
) AS latest_pre
ON p.id = latest_pre.max_id
) AS pre_test_data
ON pp.peserta_id = pre_test_data.peserta_id AND pp.pelatihan_id = pre_test_data.pelatihan_id

LEFT JOIN (
-- Subquery untuk mengambil skor post-test terbaru dan status kelulusan
SELECT
p.peserta_id,
p.pelatihan_id,
p.skor AS nilai_post_test,
CASE WHEN p.lulus = 1 THEN 'Lulus' ELSE 'Belum Lulus' END AS status
FROM percobaan AS p
INNER JOIN (
SELECT peserta_id, pelatihan_id, MAX(id) AS max_id
FROM percobaan
WHERE tipe = 'post-test' AND peserta_id IS NOT NULL AND pelatihan_id IS NOT NULL
GROUP BY peserta_id, pelatihan_id
) AS latest_post
ON p.id = latest_post.max_id
) AS post_test_data
ON pp.peserta_id = post_test_data.peserta_id AND pp.pelatihan_id = post_test_data.pelatihan_id

SET
pp.nilai_pre_test = COALESCE(pre_test_data.nilai_pre_test, pp.nilai_pre_test),
pp.nilai_post_test = COALESCE(post_test_data.nilai_post_test, pp.nilai_post_test),
pp.status = COALESCE(post_test_data.status, 'Belum Lulus');

cek kompetensi_id lama ke kompetensi_id baru

COUNT(\*)
OR

SELECT

pp.id AS id_pendaftaran,
pp.kompetensi_id AS id_kompetensi_lama,
bp.id AS id_kompetensi_baru_yang_akan_dipakai

FROM
`pendaftaran_pelatihan` AS pp
JOIN
`kompetensi_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`kompetensi_id` = bp.`kompetensi_id`;

update kompetensi_id lama ke kompetensi_Id baru
UPDATE
`pendaftaran_pelatihan` AS pp
JOIN
`kompetensi_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`kompetensi_id` = bp.`kompetensi_id`
SET
pp.`kompetensi_id` = bp.`id`;

SELECT
pp.id AS id_pendaftaran,
pp.kompetensi_id AS id_kompetensi_lama,
bp.id AS id_kompetensi_baru_yang_akan_dipakai

FROM
`pendaftaran_pelatihan` AS pp
JOIN
`kompetensi_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`kompetensi_id` = bp.`kompetensi_id`
ORDER BY PP.id asc;

95 ~ 114
140 ~ 150
180 an

AH KOPLAK, konsistensi data yang ada di mtu & mjc di pelatihan 10 & 11 masih belum konsisten

TODO, ngulik, ngecek pendaftaran_pelatihan dan diesuaikan dengan kompetensi_pelatihan

foto - malang
video - magetan
plc - nganjuk
tptu - kediri
tptu - tuban

SELECT kompetensi_id, COUNT(\*) AS jumlah_peserta
FROM peserta
WHERE pelatihan_id = 1
GROUP BY kompetensi_id;

SELECT kompetensi_id, COUNT(\*) AS jumlah_peserta
FROM pendaftaran_pelatihan
WHERE pelatihan_id = 1
GROUP BY kompetensi_id;

nambahin data terbaru lalu ditampilkan

tata boga v
tata busana v
tata kecantikan v
tptu v
web desain V
desain grafis V
motion animasi V
foto produk V
videografi V
fotografi V
plc V

injection 8 data pelatihan
DONE pelatihan
DONE kompetensi
DONE kompetensi_pelatihan
TODO pretest
TODO posttest
TODO praktek
TODO semua nilai (tanpa nilai survei)
TODO semua jawaban user (pretest, possttest, survey / monev)

masukkin data pretest
dari pretest posttest -> jadikan diagram (ambil dari survey)

MONEV
monev aksel guru
monev aksel Teknik guru
monev aksel Teknik siswa
monev siswa aksel mjc
monev siswa regular Teknik 1
monev siswa regular mjc 1
monev siswa regular mjc 2
monev siswa mtu 1

sudah di database
monev siswa regular Teknik 2
monev siswa mtu 2

PRETEST
⦁ pretest aksel guru 5 done
⦁ pretest aksel Teknik guru 4 done
⦁ pretest aksel Teknik siswa 4 done
⦁ pretest siswa aksel mjc 5 done
⦁ pretest siswa regular Teknik 1 4 done
⦁ pretest siswa regular Teknik 2 4 done
⦁ pretest siswa regular mjc 1 5 done
⦁ pretest siswa regular mjc 2 5 done
⦁ pretest siswa mtu 1 4 done (5 actually)

sudah di database (cek ulang)
⦁ pretest siswa regular Teknik 2 v
⦁ pretest siswa mtu 2 v

POSTTEST
⦁ posttest aksel guru 5 done
⦁ posttest aksel Teknik guru 4 done
⦁ posttest aksel Teknik siswa 4 done
⦁ posttest siswa aksel mjc 5 done
⦁ posttest siswa regular Teknik 1 4 done
⦁ posttest siswa regular Teknik 2 4 done
⦁ posttest siswa regular mjc 1 5 done
⦁ posttest siswa regular mjc 2 5 done
⦁ posttest siswa mtu 1 4 done (actualy 5)

sudah di database
⦁ posttest siswa regular Teknik 2 x
⦁ posttest siswa mtu 2 x

CREATE TABLE id_mapping(
`old_id` bigint(20) unsigned NOT NULL,
`new_id` bigint(20) unsigned NOT NULL,

PRIMARY KEY (`old_id`),
UNIQUE KEY `new_id` ( `new_id`)
)

INSERT INTO `id_mapping` (`old_id`,`new_id`)
VALUES
(1,43),
(2,42),
(3,40),
(4,41),
(5,103),
(6,1),
(7,2),
(8,3),
(98,4),
(99,5),
(100,6),
(101,7),
(102,8);

web-content

-   upload banner (hero)
-   Berita
-   Sorotan pelatihan (judul, keterangan, foto-foto)
-   kompetensi kompetensi pelatihan
-   statistik (iki sg rata rata pretest post test)
-   edit kepala upt (foto, nama)
-   text pelatihan (syarat ketentuan, lokasi, jadwal)

ga wajib

-   foto di cerita kami
-   foto foto di program pelatihan

pelatihan

1. informasi dasar
   jenis program diganti dropdown reguler, mtu, mjc
   batch diganti angkatan
   kuota dihapus
   instansi dihapus
   gambar dihapus
   deskripsi dihapus
   tambahkan tanggal mulai ~ tanggal selesai pelatihan

2. kurikulum & jadwal
   kompetensi awalnya disediakan 1 card saja
   modul di komen terlebih dahulu
   tanggal mulai dihapus
   jam mulai selesai dihapus
   default lokasi di upt-ptkk
   metode dihapus

3. durasi pelatihan dihapus

admin
DONE - instruktur (updated schema, removed unused columns)
DONE configure db
CHECK crud filament instruktur resource
CHECK crud yang berhubungan dengan instruktur

-   create kompetensi (stuck instruktur)

-   setup tes
    CHECK test crud test di filament
    CHECK the error n solve

TESTING BRANCH MERGE-FINAL

-   nav beranda e jek dashboard peserta
    DONE - gambar di bidang resource ga muncul (nyimpen gambar e ubah jadi ke public aja soale sekalian di buat halaman user)
    DONE- ubah gambar di pelatihan susah/ gaisok // NOTE ini nanti diganti ketika deploy(config/filesystems.php:line41:branch merge-final)
    DONE - bidang diganti kompetensi - Bu Nur 1 Desember 2025
-   UELEK ADMINE PELATIHAN
    DONE - lihat gambar (hapusen sg tak block)
    DONE - lihat gambar (putih putih elek iku hapuen ae)
    DONE - lihat gambar ( si filter kategori sama status pindah ke yang tak tandain warna pink)
    DONE - lihat gambar (gausah dikei opsi tampilan grid lek elek)
    DONE - kolom table pelatihan gaush dikei gambar/cover

DONE - lihat gambar (hybrid/zoom? pic admin? hapus ae ganti total peserta:63251876)

-   uwelek tampilan e
    DONE - lihat gambar (bidang ganti kompetensi)
    DONE - 3 kotak iku hapus ae stats overview

DONE - statusmu isine ga konsisten di filter pelatihan, di table pelatihan sama yang di detail (create, edit)
DONE - nama mentor e udah diubah ga tampil di card daftar bidang pelatihan.
DONE - foto hapus nk bidang pelatihan
DONE - 12 sesi 3 tugas. lek statis gausa di gae hapus ae

DONE - data peserta terdaftar filter sama tambah peserta 22 e gabisa di pencet
DONE - liat data peserta iku lapu mok kei inisial nama peserta e
DONE - instruktur e gaisok di tambah (di bidang pelatihan)
DONE - SYARAT INFORMAI JADWAL LOKASI GA KEUBAH NK DATABASE duh
DONE - tambah peserta malah error tambah pelatihan
DONE - instruktur iku gausa digae dropdown isok ga gae format text ae (gak)

user

-   nav beranda e jek dashboard peserta
-   asrama blom di cek gaoonk data e

-   status e uda tak buka pendaftaran tapi nk user ga metu form pendaftaran e
-   export e kabeh grg isok

export peserta pelatihan:
excel
nama lengkap,
email,
asal lembaga (sekolah),
kelas,
cabdin,
jenis pelatihan,
kompetensi pelatihan (bidangnya apa misal fotografi),
nama angkatan pelatihannya (misal milea...),
no hp,
link drive pas foto

TODO - hasil tes survey kumulasi Total (Indeks Kepuasan) jadiin pie chart
TODO - hasil tes survey lain e blom di cek gaonk data e

-   emailing peserta

DONE
kolom tabel instruktur
data pribadi:
user_id
nama,
tempat lahir,
tanggal lahir,
jenis kelamin,
agama,
no hp
lampiran : cv, ktp, ijazah, sertifikat kompetensi

pdf: biodata peserta

nambah data pretest, posttest, monev

export full pelatihan
export per pelatihan

# Alur Pendaftaran (Controller ke View)

Berikut adalah penjelasan alur data dari `PendaftaranController` hingga tertampil di `daftar.blade.php`:

## 1. Route Definition (`routes/web.php`)

Ketika user mengakses URL `/daftar`:

```php
Route::get('/daftar', [PendaftaranController::class, 'index'])->name('pendaftaran.daftar');
```

Request diarahkan ke method `index` pada `PendaftaranController`.

## 2. Controller Logic (`app/Http/Controllers/PendaftaranController.php`)

Method `index()` bertugas menyiapkan data yang dibutuhkan oleh form pendaftaran.

```php
public function index()
{
    // 1. Mengambil Data Master untuk Dropdown
    $kompetensi  = Kompetensi::all();   // Untuk pilihan "Kompetensi Keahlian"
    $cabangDinas = CabangDinas::all();  // Untuk pilihan "Cabang Dinas"

    // 2. Mengambil Satu Pelatihan Aktif
    // Logic: Status 'Pendaftaran Buka' DAN tanggal selesai belum lewat.
    // Diambil yang tanggal mulainya paling dekat (orderBy asc).
    $pelatihan = Pelatihan::wi\th(['kompetensiPelatihan.kompetensi', 'kompetensiPelatihan.instruktur'])
        ->where('status', 'Pendaftaran Buka')
        ->whereDate('tanggal_selesai', '>=', now())
        ->orderBy('tanggal_mulai', 'asc')
        ->first();

    // 3. Mengirim Data ke View
    return view('pages.daftar', compact('kompetensi', 'cabangDinas', 'pelatihan'));
}
```

## 3. View Logic (`resources/views/pages/daftar.blade.php`)

View menerima variabel `$kompetensi`, `$cabangDinas`, dan `$pelatihan`.

### A. Pengecekan Pelatihan Aktif

View mengecek apakah ada pelatihan yang tersedia:

```blade
@php
  $adaPelatihanAktif = isset($pelatihan) && $pelatihan !== null;
@endphp

@if (! $adaPelatihanAktif)
  <!-- TAMPILAN JIKA TIDAK ADA PELATIHAN -->
  <!-- Menampilkan pesan "Saat ini belum ada program pelatihan..." -->
@else
  <!-- TAMPILAN FORM PENDAFTARAN -->
@endif
```

### B. Penggunaan Data di Form

Jika ada pelatihan aktif, data digunakan di dalam form:

1.  **ID Pelatihan (Hidden Input)**:

    ```blade
    <input type="hidden" name="pelatihan_id" value="{{ $pelatihan->id }}">
    ```

    Disimpan agar saat submit, sistem tahu user mendaftar ke pelatihan mana.

2.  **Dropdown Kompetensi**:
    Looping variabel `$kompetensi` untuk mengisi opsi select box.

    ```blade
    <select name="kompetensi_keahlian" ...>
        @foreach ($kompetensi as $b)
            <option value="{{ $b->id }}">{{ $b->nama_kompetensi }}</option>
        @endforeach
    </select>
    ```

3.  **Dropdown Cabang Dinas**:
    Looping variabel `$cabangDinas`.

    ```blade
    <select name="cabangDinas_id" ...>
        @foreach ($cabangDinas as $cb)
            <option value="{{ $cb->id }}">{{ $cb->nama }}</option>
        @endforeach
    </select>
    ```

4.  **Informasi Pelatihan (Accordion)**:
    Menampilkan detail pelatihan seperti tanggal mulai/selesai dan lokasi menggunakan data dari `$pelatihan`.

## 4. Form Submission (Client-Side ke Server-Side)

Saat user menekan tombol **Submit**:

1.  **Validasi JavaScript**: Script di bagian bawah view memvalidasi input per langkah (wizard step 1, 2, 3).
2.  **Post Request**: Jika valid, form dikirim via POST ke route `pendaftaran.store`.
    ```blade
    <form action="{{ route('pendaftaran.store') }}" method="POST" ...>
    ```
3.  **Controller Processing**: Method `store()` di Controller menerima semua data, melakukan validasi server-side, menyimpan ke database (transaksi), dan me-redirect ke halaman sukses (`pendaftaran.selesai`).

instansi
user
peserta
lampiranpeserta
pendaftaranpelatihan

assesment

Route::view('/masuk', 'pages.masuk')->name('masuk');
masuk blade
home blade
posttest blade
posttest start
posttest result
pretest blade
pretest start
pretest result
materi blade
dashboardcontroller

=================================================================
ALUR SYSTEM CBT (COMPUTER BASED TEST)
=================================================================
(Tracing dari DashboardController, Views, & Routes + Konfirmasi User)

0. REGISTRASI & PENENTUAN SCOPE (Hulu)

    - Peserta melakukan registrasi -> Data masuk ke tabel `peserta` & `pendaftaran_pelatihan`.
    - Di `pendaftaran_pelatihan`, tersimpan `kompetensi_id` (dari `kompetensi_pelatihan`).
    - KUNCI: Kolom `kompetensi_id` di `pendaftaran_pelatihan` ini yang menentukan soal mana yang akan muncul nanti (Pre/Post Test).

1. LOGIN PESERTA

    - URL: /masuk (view: pages.masuk)
    - Form submit ke: route('assessment.login.submit')
    - Controller: AssessmentLoginController@submit
    - Logic: Cek token/password -> Set Session (peserta_id / pesertaSurvei_id) -> Redirect ke /dashboard

2. DASHBOARD HOME (Penentuan Soal)

    - URL: /dashboard (view: dashboard.pages.home)
    - Controller: DashboardController@home
    - Logic:
        - `requireLogin()`: memastikan sesi login ada.
        - `ensureActiveTrainingSession()`:
          -> Cek tabel `pendaftaran_pelatihan` berdasarkan peserta yang login.
          -> Ambil `pelatihan_id` & `kompetensi_id` dari pendaftaran tsb.
          -> Simpan ke SESSION.
        - Filter Soal: Saat user klik Pre/Post Test, sistem otomatis memfilter soal yang `kompetensi_id`-nya COCOK dengan yang ada di session (hasil pendaftaran tadi).

3. POST-TEST FLOW (Studi Kasus)
   A. Index Post-Test

    - URL: /dashboard/posttest (view: dashboard.pages.post-test.posttest)
    - Controller: DashboardController@posttest
    - Logic:
        - Load tes tipe 'post-test'.
        - Filter: Hanya tampilkan tes yang `kompetensi_id`-nya sama dengan sesi peserta.
        - Cek Percobaan (history):
            - Jika DONE (waktu_selesai != null) -> Tampil nilai & tombol "Lihat Hasil".
            - Jika RUNNING (waktu_selesai == null) -> Tombol "Lanjutkan".
            - Jika NEW -> Tombol "Mulai".

    B. Memulai Tes (Start)

    - Action: Klik "Mulai" -> route('dashboard.posttest.start', $tes->id)
    - Controller: DashboardController@posttestStart -> method startByTes()
    - Logic:
        - Buat record tabel `percobaan` baru (waktu_mulai = NOW).
        - Redirect ke halaman pengerjaan (Exam View).

    C. Pengerjaan Soal (Exam View)

    - URL: /dashboard/posttest/{tes}?percobaan={id} (view: dashboard.pages.post-test.posttest-start)
    - Controller: DashboardController@posttestShow
    - Fitur View:
        - Timer hitung mundur (durasi_menit).
        - List Nomor Soal.
        - Anti-Cheat (blur/resize detection).
    - Action: Submit jawaban / Pindah soal -> POST ke route('dashboard.posttest.submit')

    D. Submit & Selesai

    - Controller: DashboardController@posttestSubmit
    - Logic:
        - Simpan jawaban opsi yang dipilih ke `jawaban_users`.
        - Jika tombol "Selesai" -> update `waktu_selesai` di tabel `percobaan`, hitung skor.
        - Redirect ke Result.

    E. Result (Hasil)

    - URL: /dashboard/posttest/result/{percobaan} (view: dashboard.pages.post-test.posttest-result)
    - Controller: DashboardController@posttestResult
    - Logic: Tampilkan skor, kategori nilai, status lulus/tidak, & improvement dari Pre-Test.

4. MATERI FLOW
    - Index: /dashboard/materi (dashboard.pages.materi.materi-index)
    - Show: /dashboard/materi/{slug} (dashboard.pages.materi.materi-show)
    - Logic:
        - Menampilkan konten berdasarkan tipe (Video/PDF/Teks/Link).
        - Tombol "Tandai Selesai" -> POST route('dashboard.materi.complete').
        - Sidebar "Materi Terkait" untuk navigasi cepat.

Catatan Arsip: Flow ini otomatis tercatat agar tidak lupa saat development fitur berikutnya.


tambahkan juga otomatisasi tesnya ketika sudah mengerjakan maka akan tersimpan di @Percobaan.php dan juga nanti skornya akan masuk di @PendaftaranPelatihan.php sesuai pengerjaan pretest / posttest (kolom nilai_pre_test / nilai_post_test)



INFORMASI PENDAFTARAN
ID Peserta : [ID Peserta]
Nama : [Nama Peserta]
Asal lembaga : [Asal Lembaga]
Cabang Dinas Wilayah: [Cabang Dinas]
Kompetensi Pelatihan yang Diikuti: [Kompetensi]
Kamar Asrama Penginapan: [Kamar Asrama]

WAKTU DAN TEMPAT PELAKSANAAN
Waktu : [Waktu Mulai] - [Waktu Selesai]
Lokasi : [Lokasi], [Alamat Lengkap]
Catatan Penting !!!
1. Peserta diharapkan membawa dokumen administrasi lengkap.
2. Kegiatan Pembelajaran dan Proses Administrasi dilakukan secara offline dan peserta diharapkan datang tepat waktu.

DOKUMEN ADMINISTRASI YANG WAJIB DIBAWA
1.  Fotocopy Ijazah terakhir 
2. Pas Foto formal background merah (ukuran 3x4 cm sebanyak 3 lembar), pakaian kemeja putih, jilbab hitam polos (bagi yang berjilbab) 
3. Surat Tugas yang telah ditandatangani oleh pejabat berwenang di Cabang Dinas Pendidikan Provinsi Jawa Timur setempat 
4. Fotocopy KTP/KK atau Kartu Pelajar/Surat Keterangan yang menyatakan sebagai siswa aktif dari lembaga masing-masing 
5. Surat Keterangan Sehat [bagi peserta Reguler dan Akselerasi]

TATA TERTIB PESERTA
- Hadir 15 menit sebelum pelatihan dimulai
- Mengisi dan menandatangani daftar hadir
- Tidak meninggalkan kegiatan tanpa izin panitia 
- Dilarang merokok saat pelatihan berlangsung
- Jika sakit, wajib memberitahu panitia
- Ketidakhadiran lebih dari 20% tanpa alasan sah → dinyatakan tidak lulus
- Tidak diperbolehkan keluar dari lingkungan UPT PTKK
- Pelanggaran tata tertib → dikembalikan ke lembaga asal

KETENTUAN SERAGAM DAN BARANG BAWAAN
- Membawa pakaian kemeja putih, bawahan warna hitam, jilbab hitam (Putri) selama mengikuti pelatihan
- Membawa pakaian olahraga lengkap, dan membawa pakaian bebas rapi, sopan, untuk aktifitas sehari-hari.  

Informasi Tambahan:
- Informasi dan konfirmasi lebih lanjut dapat menghubungi [CP(dinamis sesuai input)]
-> (bisa dinamis) Sdri. Pramudya Putri Dewanti, S.Pi (CP. – 082249999447).

Hormat Kami,
UPT. Pengembangan Teknis dan Keterampilan Kejuruan
Dinas Pendidikan Provinsi Jawa Timur