=================================================================
KONSEP ARSITEKTUR
=================================================================

=================================================================
IMPLEMENTASI
=================================================================
siap—kita fokus “membongkar” controller pendaftaran yang gemuk jadi potongan kecil yang rapi. Karena kamu minta **belum menulis kode**, di bawah ini adalah **daftar file** + **peran masing-masing** yang biasanya diperlukan untuk kasus pendaftaran peserta (dengan entitas: peserta, user/operator, instansi, bidang, pelatihan, lampiran, dan alur status).

---

# 0) Gambaran permasalahan di controller gemuk

Biasanya berisi campuran:

-   Validasi request (panjang)
-   Otorisasi (role/ownership)
-   Query & filter list (search, sort, paginate)
-   Transaksi bisnis (generate nomor registrasi, cek unik, simpan lampiran)
-   Perubahan status (submit/verify/approve/reject)
-   Notifikasi/email, export, dsb.

Semuanya kita **pecah**: validasi → FormRequest, logika bisnis → Actions/Services, otorisasi → Policy, query → Repository/QueryObject, lampiran → Service khusus storage, output API → Resource, efek samping → Event/Listener/Job, aturan khusus → Rule, hal otomatis → Observer. Controller tinggal jadi _orchestrator_ tipis.

---

# 1) HTTP Requests (validasi & otorisasi per-endpoint)

Taruh semua aturan validasi di sini, bukan di controller.

-   `app/Http/Requests/Pendaftaran/StoreRequest.php`
-   `app/Http/Requests/Pendaftaran/UpdateRequest.php`
-   `app/Http/Requests/Pendaftaran/ChangeStatusRequest.php` (opsional)
-   `app/Http/Requests/Pendaftaran/UploadLampiranRequest.php`

**Fokus:** aturan field, exists/unique, korelasi antar field (mis. `bidang_id` harus milik `instansi_id`), otorisasi endpoint (boleh create/edit?).

---

# 2) Policies (izin per aksi pada model)

Agar controller tidak penuh if/else per role/status.

-   `app/Policies/PendaftaranPolicy.php`

**Method umum:** `viewAny, view, create, update, delete, restore, forceDelete` + kustom mis. `approve, reject, verify, uploadLampiran`.

---

# 3) Domain Actions / Services (logika bisnis inti)

Satu use-case → satu kelas. Di sinilah **transaksi DB** berlangsung.

-   `app/Actions/Pendaftaran/CreatePendaftaran.php`
    (cek unik peserta×pelatihan, generate nomor, simpan & dispatch event)
-   `app/Actions/Pendaftaran/UpdatePendaftaran.php`
-   `app/Actions/Pendaftaran/ChangeStatus.php`
    (subset: `ApprovePendaftaran`, `RejectPendaftaran`, `VerifyPendaftaran`)
-   `app/Actions/Pendaftaran/AddLampiran.php`
-   `app/Actions/Pendaftaran/RemoveLampiran.php`
-   `app/Actions/Pendaftaran/GenerateNomorRegistrasi.php` (bisa sebagai service mikro)

> Catatan: kalau di controller ada 3–5 alur berbeda (create/update/status/lampiran), pecah jadi **3–5 Action** seperti di atas.

---

# 4) Rules (aturan validasi custom & lintas field)

Supaya tidak menjejali FormRequest dengan closure panjang.

-   `app/Rules/UniquePendaftaranPerPesertaPelatihan.php`
-   `app/Rules/BidangBelongsToInstansi.php`
-   `app/Rules/ValidLampiranType.php` (opsional: cek jenis berkas terhadap pelatihan/bidang)

---

# 5) Repositories / Query Objects (query & filter rapi)

Kumpulkan logika pencarian/sort/filter/paginate.

-   `app/Repositories/PendaftaranRepository.php`
    (mis. `paginateWithFilters($filters)`, `findByNomor($nomor)`)
-   (opsional) `app/QueryBuilders/PendaftaranQuery.php` bila ingin pola QueryObject lebih ketat.

**Tujuan:** controller tidak menulis chain query panjang, cukup panggil metode repository.

---

# 6) HTTP Resources (format respons API)

Kalau endpoint kamu JSON, bentuknya jangan di controller.

-   `app/Http/Resources/PendaftaranResource.php`
-   `app/Http/Resources/LampiranResource.php`

**Manfaat:** konsisten, mudah versi, dan controller tetap tipis.

---

# 7) Services (utilitas domain & infrastruktur)

Pisahkan hal yang berpotensi dipakai lintas aksi.

-   `app/Services/Numbering/NomorRegistrasiFormatter.php`
    (format kode, padding, pola per tahun/bidang)
-   `app/Services/Storage/LampiranStorage.php`
    (path, direktori, rename, keamanan akses)
-   (opsional) `app/Services/Export/PendaftaranExporter.php` (CSV/XLSX/PDF)

---

# 8) Events, Listeners, Jobs (efek samping asinkron)

Agar controller/Action tak menangani email, logging berat, dsb.

-   `app/Events/PendaftaranSubmitted.php`
-   `app/Events/PendaftaranApproved.php`
-   `app/Events/PendaftaranRejected.php`
-   `app/Listeners/NotifyPesertaOnApproval.php`
-   `app/Jobs/SendPendaftaranEmail.php`
-   `app/Jobs/GenerateKartuPendaftaranPdf.php`

**Prinsip:** Action hanya `dispatch()`; proses berat jalan di Job.

---

# 9) Observers (otomatisasi dekat model)

Hal “otomatis” saat create/update tanpa mencemari controller.

-   `app/Observers/PendaftaranObserver.php`
    (mis. auto-generate nomor kalau kosong, normalisasi data)
-   `app/Observers/LampiranObserver.php` (opsional—hapus fisik file saat record dihapus)

---

# 10) Controllers (jadi super tipis)

Hanya orkestrasi: terima Request → authorize → panggil Action → balas Resource/View.

-   Tetap `app/Http/Controllers/PendaftaranController.php` (lebih kecil)
-   (opsional) pisah **Web** vs **API**:

    -   `PendaftaranWebController` (Blade)
    -   `PendaftaranApiController` (JSON + Resource)

---

# 11) Views / Blade Components (untuk portal publik)

Jika ada UI publik (non-admin):

-   `resources/views/pendaftaran/create.blade.php`
-   `resources/views/pendaftaran/show.blade.php`
-   `resources/views/components/pendaftaran/form.blade.php`
-   `resources/views/components/pendaftaran/lampiran-uploader.blade.php`

**Tujuan:** markup tidak menumpuk di controller, dan form bisa reusable.

---

# 12) Filament (untuk back-office/admin)

Jika kamu juga pakai Filament, UI admin pindah ke sini (controller makin bebas).

-   `app/Filament/Resources/PendaftaranResource.php`
-   `app/Filament/Resources/PendaftaranResource/Pages/{List,Create,Edit,View}.php`
-   `app/Filament/Resources/PendaftaranResource/RelationManagers/LampiranRelationManager.php`
-   `app/Filament/Widgets/PendaftaranStats.php`

**Khusus penting:** di `Create/Edit` Page, gunakan **Action** (`CreatePendaftaran`, `ChangeStatus`, dll.) agar domain logic tetap satu sumber.

---

# 13) Routes (jelas & terpisah)

-   `routes/web.php` (portal)
-   `routes/api.php` (API JSON)
-   (opsional) `routes/filament.php` (kadang otomatis oleh Filament)
-   Gunakan **Route Model Binding** untuk meringkas controller.

---

# 14) Testing (supaya refactor aman)

-   `tests/Feature/Pendaftaran/CreateTest.php`
-   `tests/Feature/Pendaftaran/StatusFlowTest.php`
-   `tests/Unit/Rules/UniquePendaftaranPerPesertaPelatihanTest.php`
-   `tests/Feature/Filament/PendaftaranResourceTest.php` (bila pakai Filament)

---

## Pemetaan “fat controller concern → file tujuan”

-   **Validasi panjang** → `StoreRequest/UpdateRequest/ChangeStatusRequest` + `Rules/*`
-   **Cek izin** → `PendaftaranPolicy`
-   **Generate nomor registrasi** → `Actions/GenerateNomorRegistrasi` (atau Service Numbering) + optional `Observer`
-   **Cek unik (peserta×pelatihan)** → `Rules/UniquePendaftaranPerPesertaPelatihan`
-   **Relasi `bidang` milik `instansi`** → `Rules/BidangBelongsToInstansi`
-   **Simpan/hapus lampiran** → `Actions/AddLampiran/RemoveLampiran` + `Services/Storage/LampiranStorage`
-   **Filter/search daftar** → `PendaftaranRepository`
-   **Perubahan status (submit/verify/approve/reject)** → `Actions/ChangeStatus` (+ Policy)
-   **Notifikasi/email/export** → `Events/Listeners/Jobs` (+ optional `Services/Export`)
-   **Respons JSON** → `Http/Resources/*`
-   **Hal otomatis saat create/update** → `Observers/*`

---

### Hasil akhirnya

-   **Controller** tinggal ±5–20 baris per method (super bersih).
-   **Logika bisnis** terkumpul rapi & bisa dipakai ulang (portal, API, admin).
-   **Validasi & izin** konsisten (tak tersebar).
-   **Query** mudah dirawat (satu pintu).
-   **Efek samping** aman via queue.

Kalau kamu mau, kirim ringkasan isi method apa saja yang ada di controller kamu (mis. `index`, `create`, `store`, `show`, `update`, `approve`, `reject`, `uploadLampiran`, `export`, dsb.). Aku akan mapping **satu-per-satu** ke daftar file di atas (tanpa menulis kode), jadi kamu dapat _blueprint_ refactor yang persis mengikuti controller milikmu.

82 ~ 97

1: 81 - 115
2: 177 - 201

export pdf untuk diagram monev

export pdf & excel untuk kebutuhan bu nur
jadwal kegiatan pelatihan total 10
jenis:

-   reguler: MJC, keterampilan (generasi emas,)
-   mtu
-   aksel: sertifikasi uji kompetensi

aksel guru: 2
mtu: 2
teknik: 2
aksel siswa: 2
mjc: 2

guru & siswa

105
191

104
105

190
191
SELECT \* FROM jawaban_user WHERE pertanyaan_id = 105;





    
-- JALANKAN QUERY INI UNTUK MEMPERBAIKI DATA JAWABAN_USER
UPDATE
  jawaban_user
SET
  opsi_jawaban_id = CASE
    -- ## Mapping untuk Pertanyaan 105 (Q24) ##
    -- Sesuaikan ID Lama => ID Baru berdasarkan peta Anda
    WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 353 THEN 708 -- Contoh untuk 'Sangat Perlu'
    WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 354 THEN 707 -- Contoh untuk 'Perlu'
    WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 355 THEN 706 -- Contoh untuk 'Kurang Perlu'
    WHEN pertanyaan_id = 105 AND opsi_jawaban_id = 356 THEN 705 -- Contoh untuk 'Tidak Perlu'
    
    -- Jaga nilai asli jika tidak cocok
    ELSE opsi_jawaban_id
  END
WHERE
  -- Filter hanya untuk pertanyaan yang relevan
  pertanyaan_id = 105 AND opsi_jawaban_id IN (353, 354, 355, 356);



-- JALANKAN QUERY INI UNTUK MEMPERBAIKI DATA JAWABAN_USER
UPDATE
  jawaban_user
SET
  opsi_jawaban_id = CASE
    -- ## Mapping untuk Pertanyaan 105 (Q24) ##
    -- Sesuaikan ID Lama => ID Baru berdasarkan peta Anda
       WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 685 THEN 712 -- Contoh untuk 'Sangat Perlu'
    WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 686 THEN 711 -- Contoh untuk 'Perlu'
    WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 687 THEN 710 -- Contoh untuk 'Kurang Perlu'
    WHEN pertanyaan_id = 191 AND opsi_jawaban_id = 688 THEN 709 -- Contoh untuk 'Tidak Perlu'
 
    -- Jaga nilai asli jika tidak cocok
    ELSE opsi_jawaban_id
  END
WHERE
  -- Filter hanya untuk pertanyaan yang relevan
  pertanyaan_id = 191 AND opsi_jawaban_id IN (685, 686, 687, 688);



<!-- rubah db -->
ALTER TABLE percobaan
ADD COLUMN tipe ENUM('pre-test', 'post-test', 'survey') NULL AFTER tes_id;

UPDATE percobaan
SET tipe = 'survey'
WHERE (skor IS NULL OR skor = 0) AND tes_id IN (5, 9);

UPDATE percobaan
SET tipe = 'post-test'
WHERE skor IS NOT NULL AND skor > 0;

nambahin peserta_id otomatis


perubahan untuk asrama

ASRAMA
id 
name
gender


KAMAR
id 
asrama
nomor_kamar
lantai
status
total_beds
available_beds


penambahan kolom
tabel percobaan
+ pelatihan_id 


tabel peserta 
+ pretest
+ posttest
+ praktek
+ rata rata
+ nilai survei
+ status





mindah nilai ke pendafaran pelatihan
UPDATE pendaftaran_pelatihan AS pp
LEFT JOIN (
    -- Subquery untuk mengambil skor pre-test terbaru
    SELECT
        p.peserta_id,
        p.pelatihan_id,
        p.skor AS nilai_pre_test
    FROM percobaan AS p
    INNER JOIN (
        SELECT peserta_id, pelatihan_id, MAX(id) AS max_id
        FROM percobaan
        WHERE tipe = 'pre-test' AND peserta_id IS NOT NULL AND pelatihan_id IS NOT NULL
        GROUP BY peserta_id, pelatihan_id
    ) AS latest_pre
    ON p.id = latest_pre.max_id
) AS pre_test_data
ON pp.peserta_id = pre_test_data.peserta_id AND pp.pelatihan_id = pre_test_data.pelatihan_id

LEFT JOIN (
    -- Subquery untuk mengambil skor post-test terbaru dan status kelulusan
    SELECT
        p.peserta_id,
        p.pelatihan_id,
        p.skor AS nilai_post_test,
        CASE WHEN p.lulus = 1 THEN 'Lulus' ELSE 'Belum Lulus' END AS status
    FROM percobaan AS p
    INNER JOIN (
        SELECT peserta_id, pelatihan_id, MAX(id) AS max_id
        FROM percobaan
        WHERE tipe = 'post-test' AND peserta_id IS NOT NULL AND pelatihan_id IS NOT NULL
        GROUP BY peserta_id, pelatihan_id
    ) AS latest_post
    ON p.id = latest_post.max_id
) AS post_test_data
ON pp.peserta_id = post_test_data.peserta_id AND pp.pelatihan_id = post_test_data.pelatihan_id

SET
    pp.nilai_pre_test = COALESCE(pre_test_data.nilai_pre_test, pp.nilai_pre_test),
    pp.nilai_post_test = COALESCE(post_test_data.nilai_post_test, pp.nilai_post_test),
    pp.status = COALESCE(post_test_data.status, 'Belum Lulus');







cek bidang_id lama ke bidang_id baru

COUNT(*)
OR

SELECT

pp.id AS id_pendaftaran,
  pp.bidang_id AS id_bidang_lama,
  bp.id AS id_bidang_baru_yang_akan_dipakai


FROM
  `pendaftaran_pelatihan` AS pp
JOIN
  `bidang_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`bidang_id` = bp.`bidang_id`;



update bidang_id  lama ke bidang_Id baru
UPDATE
  `pendaftaran_pelatihan` AS pp
JOIN
  `bidang_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`bidang_id` = bp.`bidang_id`
SET
  pp.`bidang_id` = bp.`id`;



SELECT
pp.id AS id_pendaftaran,
  pp.bidang_id AS id_bidang_lama,
  bp.id AS id_bidang_baru_yang_akan_dipakai


FROM
  `pendaftaran_pelatihan` AS pp
JOIN
  `bidang_pelatihan` AS bp ON pp.`pelatihan_id` = bp.`pelatihan_id` AND pp.`bidang_id` = bp.`bidang_id`
  ORDER BY PP.id asc;

95 ~ 114
140 ~ 150
180 an


AH KOPLAK, konsistensi data yang ada di mtu & mjc di pelatihan 10 & 11 masih belum konsisten

TODO, ngulik, ngecek pendaftaran_pelatihan dan diesuaikan dengan bidang_pelatihan 

foto - malang
video - magetan
plc - nganjuk
tptu - kediri
tptu - tuban


SELECT bidang_id, COUNT(*) AS jumlah_peserta
FROM peserta
WHERE pelatihan_id = 1
GROUP BY bidang_id;




SELECT bidang_id, COUNT(*) AS jumlah_peserta
FROM pendaftaran_pelatihan
WHERE pelatihan_id = 1
GROUP BY bidang_id;


nambahin data terbaru lalu ditampilkan 

tata boga         v 
tata busana       v
tata kecantikan   v
tptu              v
web desain        V
desain grafis     V
motion animasi    V
foto produk       V
videografi        V
fotografi         V
plc               V


injection 8 data pelatihan 
DONE pelatihan
DONE bidang
DONE bidang_pelatihan 
TODO pretest
TODO posttest
TODO praktek
TODO semua nilai (tanpa nilai survei)
TODO semua jawaban user (pretest, possttest, survey / monev)




masukkin data pretest
dari pretest posttest  -> jadikan diagram (ambil dari survey)


MONEV
monev aksel guru
monev aksel Teknik guru
monev aksel Teknik siswa
monev siswa aksel mjc 
monev siswa regular Teknik 1
monev siswa regular mjc 1
monev siswa regular mjc 2
monev siswa mtu 1


sudah di database
monev siswa regular Teknik 2
monev siswa mtu 2


PRETEST
⦁	pretest aksel guru 			5 done
⦁	pretest aksel Teknik guru		4 done
⦁	pretest aksel Teknik siswa		4 done
⦁	pretest siswa aksel mjc 		5 done
⦁	pretest siswa regular Teknik 1	4 done
⦁	pretest siswa regular Teknik 2	4 done
⦁	pretest siswa regular mjc 1		5 done
⦁	pretest siswa regular mjc 2		5 done
⦁	pretest siswa mtu 1			4 done (5 actually)


sudah di database (cek ulang)
⦁	pretest siswa regular Teknik 2	v
⦁	pretest siswa mtu 2			v




POSTTEST
⦁	posttest aksel guru			      5 done
⦁	posttest aksel Teknik guru		4 done
⦁	posttest aksel Teknik siswa		4 done
⦁	posttest siswa aksel mjc 		  5 done
⦁	posttest siswa regular Teknik 1	4 done
⦁	posttest siswa regular Teknik 2	4 done
⦁	posttest siswa regular mjc 1		5 done
⦁	posttest siswa regular mjc 2		5 done
⦁	posttest siswa mtu 1			4 done (actualy 5)


sudah di database
⦁	posttest siswa regular Teknik 2	x
⦁	posttest siswa mtu 2			x

CREATE TABLE id_mapping(
  `old_id` bigint(20) unsigned NOT NULL,
  `new_id` bigint(20) unsigned NOT NULL,

  PRIMARY KEY (`old_id`),
  UNIQUE KEY `new_id` ( `new_id`)
)


INSERT INTO `id_mapping` (`old_id`,`new_id`)
VALUES
(1,43),
(2,42),
(3,40),
(4,41),
(5,103),
(6,1),
(7,2),
(8,3),
(98,4),
(99,5),
(100,6),
(101,7),
(102,8);



jawaban_user